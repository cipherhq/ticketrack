// Supported currencies configuration

export const currencies = {
  NGN: {
    code: 'NGN',
    symbol: '₦',
    name: 'Nigerian Naira',
    country: 'Nigeria',
    locale: 'en-NG',
    paymentProvider: 'paystack',
  },
  GBP: {
    code: 'GBP',
    symbol: '£',
    name: 'British Pound',
    country: 'United Kingdom',
    locale: 'en-GB',
    paymentProvider: 'stripe',
  },
  USD: {
    code: 'USD',
    symbol: '$',
    name: 'US Dollar',
    country: 'United States',
    locale: 'en-US',
    paymentProvider: 'stripe',
  },
  KES: {
    code: 'KES',
    symbol: 'KSh',
    name: 'Kenyan Shilling',
    country: 'Kenya',
    locale: 'en-KE',
    paymentProvider: 'paystack',
  },
  GHS: {
    code: 'GHS',
    symbol: 'GH₵',
    name: 'Ghanaian Cedi',
    country: 'Ghana',
    locale: 'en-GH',
    paymentProvider: 'paystack',
  },
  ZAR: {
    code: 'ZAR',
    symbol: 'R',
    name: 'South African Rand',
    country: 'South Africa',
    locale: 'en-ZA',
    paymentProvider: 'paystack',
  },
};

// Default currency
export const defaultCurrency = 'NGN';

// Get currency by code
export const getCurrency = (code) => currencies[code] || currencies[defaultCurrency];

// Format price with currency
export const formatPrice = (amount, currencyCode = 'NGN') => {
  const currency = getCurrency(currencyCode);
  
  if (amount === 0) return 'Free';
  if (!amount && amount !== 0) return `${currency.symbol}0`;
  
  return new Intl.NumberFormat(currency.locale, {
    style: 'currency',
    currency: currency.code,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
};

// Get currencies as array for dropdowns
export const currencyOptions = Object.values(currencies).map(c => ({
  value: c.code,
  label: `${c.symbol} - ${c.name}`,
  symbol: c.symbol,
}));

// Format multiple currencies for display
// Input: { NGN: 5000, USD: 200, GBP: 150 }
// Output: "₦5,000 · $200 · £150"
export const formatMultiCurrency = (amountsByCurrency) => {
  if (!amountsByCurrency || typeof amountsByCurrency !== 'object') {
    return formatPrice(0, 'NGN');
  }
  
  const entries = Object.entries(amountsByCurrency)
    .filter(([_, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]); // Sort by amount descending
  
  if (entries.length === 0) {
    return formatPrice(0, 'NGN');
  }
  
  if (entries.length === 1) {
    return formatPrice(entries[0][1], entries[0][0]);
  }
  
  return entries
    .map(([currency, amount]) => formatPrice(amount, currency))
    .join(' · ');
};

// Format multiple currencies in compact form (for cards)
// Input: { NGN: 50000, USD: 200 }
// Output: "₦50K · $200"
export const formatMultiCurrencyCompact = (amountsByCurrency) => {
  if (!amountsByCurrency || typeof amountsByCurrency !== 'object') {
    return formatPrice(0, 'NGN');
  }
  
  const entries = Object.entries(amountsByCurrency)
    .filter(([_, amount]) => amount > 0)
    .sort((a, b) => b[1] - a[1]);
  
  if (entries.length === 0) {
    return formatPrice(0, 'NGN');
  }
  
  const formatCompact = (amount, currencyCode) => {
    const currency = getCurrency(currencyCode);
    if (amount >= 1000000) {
      return `${currency.symbol}${(amount / 1000000).toFixed(1)}M`;
    } else if (amount >= 1000) {
      return `${currency.symbol}${(amount / 1000).toFixed(0)}K`;
    }
    return `${currency.symbol}${amount.toLocaleString()}`;
  };
  
  if (entries.length === 1) {
    return formatCompact(entries[0][1], entries[0][0]);
  }
  
  return entries
    .map(([currency, amount]) => formatCompact(amount, currency))
    .join(' · ');
};

// Cache for user's default currency
let userDefaultCurrency = null;

// Get user's default currency from their country
export const getUserDefaultCurrency = async (supabase, userId) => {
  if (userDefaultCurrency) return userDefaultCurrency;
  
  try {
    // Get user's country from profile
    const { data: profile } = await supabase
      .from('profiles')
      .select('country')
      .eq('id', userId)
      .single();
    
    if (profile?.country) {
      // Get default currency for that country
      const { data: country } = await supabase
        .from('countries')
        .select('default_currency')
        .eq('code', profile.country)
        .single();
      
      if (country?.default_currency) {
        userDefaultCurrency = country.default_currency;
        return userDefaultCurrency;
      }
    }
  } catch (err) {
    console.error('Error getting default currency:', err);
  }
  
  return null; // Let component decide fallback
};

// Clear cache on logout
export const clearUserCurrencyCache = () => {
  userDefaultCurrency = null;
};
